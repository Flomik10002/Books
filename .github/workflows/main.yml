name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.1"
          channel: "stable"

      - name: Install dependencies
        run: flutter pub get

      - name: Decode certificate and provisioning
        env:
          P12_B64: ${{ secrets.IOS_P12_BASE64 }}
          MOBILEPROVISION_B64: ${{ secrets.IOS_PROVISIONING_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          echo "$P12_B64" | base64 --decode > signing.p12
          echo "$MOBILEPROVISION_B64" | base64 --decode > app.mobileprovision

      - name: Install certificate
        env:
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          security create-keychain -p "" build.keychain
          security import signing.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          UUID=$(grep -a -E -o "[-A-F0-9]{36}" app.mobileprovision | head -1)
          cp app.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision

      - name: Build IPA
        run: |
          flutter build ios --release --no-codesign
          xcodebuild -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath build/ios/ipa \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }}

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReaderX-ipa
          path: build/ios/ipa/*.ipa
